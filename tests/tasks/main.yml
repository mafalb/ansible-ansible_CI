# vim: set ft=yaml ts=2:
---

- name: debug environment
  debug: var=ansible_env
  tags:
  - never
  - debug

- name: check docker version on travis-CI
  when:
  - ansible_env.CI == 'travis'
  check_mode: true
  package:
    name: docker-ce
    state: present
  register: _docker_package

- name: assert that the correct docker package is installed on travis-CI
  when:
  - ansible_env.CI == 'travis'
  assert:
    that:
    - not _docker_package.changed

- name: debug docker container variables
  with_items: "{{ targeted_distributions }}"
  debug: msg="{{ item.image }} || {{ item.container }} || {{ item.src }}"

- name: docker images does exist
  with_items: "{{ targeted_distributions }}"
  docker_image:
    name: "{{ item.image }}"
    path: "{{ role_path + '/../files/' + item.src }}"
    state: present

- name: docker containers are running
  with_items: "{{ targeted_distributions }}"
  docker_container:
    name: "{{ item.container }}"
    image: "{{ item.image }}"
    volumes: /sys/fs/cgroup:/sys/fs/cgroup:ro
    state: started

- name: add containers to inventory
  changed_when: false
  with_items: "{{ targeted_distributions }}"
  add_host:
    groups: testnodes
    name: "{{ item.container }}"
    ansible_connection: docker
